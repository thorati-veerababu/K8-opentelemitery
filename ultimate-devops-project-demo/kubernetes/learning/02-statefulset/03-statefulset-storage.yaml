# ============================================================
# STATEFULSET WITH PERSISTENT STORAGE
# ============================================================
#
# üìö VOLUMECLAIMTEMPLATES:
#
# This is the KILLER FEATURE of StatefulSets!
# Each pod automatically gets its OWN PersistentVolumeClaim.
#
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ                                                              ‚îÇ
# ‚îÇ  StatefulSet: mysql (replicas: 3)                           ‚îÇ
# ‚îÇ                                                              ‚îÇ
# ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
# ‚îÇ  ‚îÇ mysql-0  ‚îÇ    ‚îÇ mysql-1  ‚îÇ    ‚îÇ mysql-2  ‚îÇ              ‚îÇ
# ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
# ‚îÇ       ‚îÇ               ‚îÇ               ‚îÇ                     ‚îÇ
# ‚îÇ       ‚ñº               ‚ñº               ‚ñº                     ‚îÇ
# ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
# ‚îÇ  ‚îÇ PVC      ‚îÇ    ‚îÇ PVC      ‚îÇ    ‚îÇ PVC      ‚îÇ              ‚îÇ
# ‚îÇ  ‚îÇ data-    ‚îÇ    ‚îÇ data-    ‚îÇ    ‚îÇ data-    ‚îÇ              ‚îÇ
# ‚îÇ  ‚îÇ mysql-0  ‚îÇ    ‚îÇ mysql-1  ‚îÇ    ‚îÇ mysql-2  ‚îÇ              ‚îÇ
# ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
# ‚îÇ       ‚îÇ               ‚îÇ               ‚îÇ                     ‚îÇ
# ‚îÇ       ‚ñº               ‚ñº               ‚ñº                     ‚îÇ
# ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
# ‚îÇ  ‚îÇ EBS Vol  ‚îÇ    ‚îÇ EBS Vol  ‚îÇ    ‚îÇ EBS Vol  ‚îÇ              ‚îÇ
# ‚îÇ  ‚îÇ 10Gi     ‚îÇ    ‚îÇ 10Gi     ‚îÇ    ‚îÇ 10Gi     ‚îÇ              ‚îÇ
# ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
# ‚îÇ                                                              ‚îÇ
# ‚îÇ  EACH POD HAS ITS OWN ISOLATED STORAGE!                     ‚îÇ
# ‚îÇ                                                              ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#
# ============================================================

apiVersion: apps/v1
kind: StatefulSet

metadata:
  name: mysql
  labels:
    app: mysql

spec:
  serviceName: "mysql-headless"
  replicas: 2                      # üëà Start with 2 to save resources

  selector:
    matchLabels:
      app: mysql

  template:
    metadata:
      labels:
        app: mysql
    
    spec:
      containers:
        - name: mysql
          image: busybox           # üëà Using busybox to simulate (saves memory)
          
          command:
            - /bin/sh
            - -c
            - |
              echo "=== MySQL Simulation on $(hostname) ==="
              echo "Data directory: /var/lib/mysql"
              echo "Pod: $(hostname)" >> /var/lib/mysql/pod-info.txt
              echo "Started: $(date)" >> /var/lib/mysql/pod-info.txt
              echo ""
              echo "Checking persistent data..."
              cat /var/lib/mysql/pod-info.txt
              echo ""
              echo "Sleeping..."
              sleep infinity

          # ============================================================
          # VOLUME MOUNT - Mount PVC at /var/lib/mysql
          # ============================================================
          volumeMounts:
            - name: data                # üëà Must match volumeClaimTemplates name
              mountPath: /var/lib/mysql

          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 50m
              memory: 64Mi

  # ============================================================
  # VOLUME CLAIM TEMPLATES - Creates PVC per pod!
  # ============================================================
  volumeClaimTemplates:
    - metadata:
        name: data                     # üëà PVC name prefix
                                        #    Creates: data-mysql-0, data-mysql-1, data-mysql-2
      spec:
        accessModes:
          - ReadWriteOnce              # üëà EBS = RWO

        storageClassName: ebs-sc       # üëà Use our EBS StorageClass

        resources:
          requests:
            storage: 1Gi               # üëà Small for learning (1Gi each)

# ============================================================
# üß™ TEST COMMANDS:
# ============================================================
#
# 1. Apply headless service:
#    kubectl apply -f 01-headless-service.yaml
#    (or create mysql-headless service)
#
# 2. Apply this StatefulSet:
#    kubectl apply -f 03-statefulset-storage.yaml
#
# 3. Check PVCs created (one per pod!):
#    kubectl get pvc
#    (Should see: data-mysql-0, data-mysql-1)
#
# 4. Check pods:
#    kubectl get pods -l app=mysql
#
# 5. Check each pod's data:
#    kubectl exec mysql-0 -- cat /var/lib/mysql/pod-info.txt
#    kubectl exec mysql-1 -- cat /var/lib/mysql/pod-info.txt
#
# 6. Delete a pod (PVC survives!):
#    kubectl delete pod mysql-0
#    kubectl get pvc  # Still exists!
#
# 7. Pod recreates with SAME data:
#    kubectl exec mysql-0 -- cat /var/lib/mysql/pod-info.txt
#    # OLD data still there!
#
# ============================================================
#
# üìù PVC NAMING:
#    {volumeClaimTemplate.name}-{statefulset.name}-{ordinal}
#    data-mysql-0
#    data-mysql-1
#    data-mysql-2
#
# ============================================================
#
# ‚ö†Ô∏è IMPORTANT:
#    When you delete a StatefulSet, PVCs are NOT deleted!
#    This is a safety feature to prevent data loss.
#
#    To clean up:
#    kubectl delete statefulset mysql
#    kubectl delete pvc data-mysql-0 data-mysql-1
#
# ============================================================

---
# ============================================================
# HEADLESS SERVICE FOR MYSQL
# ============================================================
apiVersion: v1
kind: Service
metadata:
  name: mysql-headless
  labels:
    app: mysql
spec:
  clusterIP: None
  selector:
    app: mysql
  ports:
    - port: 3306
      name: mysql
